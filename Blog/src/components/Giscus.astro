---
import { getGiscusConfig, isGiscusConfigured } from '../config/giscus';

// Get Giscus configuration
const config = getGiscusConfig();
const isConfigured = isGiscusConfigured();
---

	{isConfigured && (
		<div id="giscus-comments" class="giscus-container">
			<!-- Giscus will be loaded dynamically after theme is determined -->
		</div>
	)}

	{!isConfigured && (
		<div class="giscus-setup-notice">
			<h3>ðŸ’¬ Comments Coming Soon</h3>
			<p>Comments will be available once Giscus is configured. Check the setup instructions in the repository.</p>
		</div>
	)}

	<!-- Universal theme synchronization script - works in both blog and Quartz environments -->
	<script>
		// Environment detection
		function detectEnvironment() {
			// Check if we're in Quartz environment
			if (document.querySelector('meta[name="generator"][content*="Quartz"]') || 
				window.location.hostname.includes('quartz') ||
				document.querySelector('.dark') !== null) {
				return 'quartz';
			}
			// Check if we're in blog environment
			if (document.querySelector('meta[name="generator"][content*="Astro"]') ||
				document.documentElement.hasAttribute('data-theme')) {
				return 'blog';
			}
			// Default to blog environment
			return 'blog';
		}

		// Universal theme detection function
		function getCurrentTheme() {
			const environment = detectEnvironment();
			
			if (environment === 'quartz') {
				// Quartz theme detection
				const darkElement = document.querySelector('.dark');
				const lightElement = document.querySelector('.light');
				
				if (darkElement) return 'dark';
				if (lightElement) return 'light';
				
				// Fallback: check for dark class on html or body
				if (document.documentElement.classList.contains('dark') || 
					document.body.classList.contains('dark')) {
					return 'dark';
				}
				
				return 'light';
			} else {
				// Blog theme detection
				const htmlElement = document.documentElement;
				const theme = htmlElement.getAttribute('data-theme');
				return theme === 'dark' ? 'dark' : 'light';
			}
		}

		// Function to update Giscus theme
		function updateGiscusTheme(theme) {
			const giscusFrame = document.querySelector('iframe[src*="giscus.app"]');
			if (giscusFrame) {
				// Send theme change message to Giscus iframe
				giscusFrame.contentWindow.postMessage({
					giscus: {
						setConfig: {
							theme: theme
						}
					}
				}, 'https://giscus.app');
			}
		}

		// Function to handle theme changes
		function handleThemeChange() {
			const currentTheme = getCurrentTheme();
			updateGiscusTheme(currentTheme);
		}

		// Universal theme change detection
		function setupThemeObserver() {
			const environment = detectEnvironment();
			
			if (environment === 'quartz') {
				// Quartz theme change detection
				const observer = new MutationObserver(function(mutations) {
					let themeChanged = false;
					mutations.forEach(function(mutation) {
						if (mutation.type === 'attributes' && 
							(mutation.attributeName === 'class' || mutation.attributeName === 'data-theme')) {
							themeChanged = true;
						}
						if (mutation.type === 'childList') {
							// Check for added/removed dark/light elements
							mutation.addedNodes.forEach(node => {
								if (node.nodeType === 1 && (node.classList.contains('dark') || node.classList.contains('light'))) {
									themeChanged = true;
								}
							});
							mutation.removedNodes.forEach(node => {
								if (node.nodeType === 1 && (node.classList.contains('dark') || node.classList.contains('light'))) {
									themeChanged = true;
								}
							});
						}
					});
					if (themeChanged) {
						setTimeout(handleThemeChange, 100);
					}
				});

				// Observe html and body elements for theme changes
				observer.observe(document.documentElement, {
					attributes: true,
					attributeFilter: ['class', 'data-theme']
				});
				observer.observe(document.body, {
					attributes: true,
					attributeFilter: ['class'],
					childList: true,
					subtree: true
				});
			} else {
				// Blog theme change detection
				const observer = new MutationObserver(function(mutations) {
					mutations.forEach(function(mutation) {
						if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
							handleThemeChange();
						}
					});
				});

				observer.observe(document.documentElement, {
					attributes: true,
					attributeFilter: ['data-theme']
				});

				// Also listen for theme toggle clicks as a backup
				document.addEventListener('click', function(event) {
					if (event.target.closest('#theme-toggle')) {
						setTimeout(handleThemeChange, 100);
					}
				});
			}
		}

		// Function to dynamically load Giscus with correct theme
		function loadGiscusWithTheme() {
			const container = document.getElementById('giscus-comments');
			if (!container) return;

			// Get current theme
			const currentTheme = getCurrentTheme();
			
			// Create Giscus script element with correct theme
			const script = document.createElement('script');
			script.src = 'https://giscus.app/client.js';
			script.setAttribute('data-repo', "{config.repo}");
			script.setAttribute('data-repo-id', "{config.repoId}");
			script.setAttribute('data-category', "{config.category}");
			script.setAttribute('data-category-id', "{config.categoryId}");
			script.setAttribute('data-mapping', "{config.mapping}");
			script.setAttribute('data-strict', "{config.strict}");
			script.setAttribute('data-reactions-enabled', "{config.reactionsEnabled}");
			script.setAttribute('data-emit-metadata', "{config.emitMetadata}");
			script.setAttribute('data-input-position', "{config.inputPosition}");
			script.setAttribute('data-theme', currentTheme);
			script.setAttribute('data-lang', "{config.lang}");
			script.setAttribute('data-loading', 'lazy');
			script.crossOrigin = 'anonymous';
			script.async = true;

			// Add script to container
			container.appendChild(script);
		}

		// Function to wait for theme to be established before loading Giscus
		function waitForThemeAndLoadGiscus() {
			let attempts = 0;
			const maxAttempts = 30; // 1.5 seconds max wait
			
			const checkTheme = setInterval(() => {
				attempts++;
				const theme = getCurrentTheme();
				
				// If we have a theme or we've waited long enough, proceed
				if (theme || attempts >= maxAttempts) {
					clearInterval(checkTheme);
					loadGiscusWithTheme();
				}
			}, 50);
		}

		// Initialize everything
		function initializeGiscusTheme() {
			// Set up theme change detection
			setupThemeObserver();
			
			// Wait for theme to be established, then load Giscus
			setTimeout(waitForThemeAndLoadGiscus, 100);
		}

		// Initialize on DOM ready
		document.addEventListener('DOMContentLoaded', initializeGiscusTheme);

		// Listen for Giscus ready event as additional safety
		window.addEventListener('message', function(event) {
			if (event.origin !== 'https://giscus.app') return;
			
			if (event.data && event.data.type === 'ready') {
				// Giscus is ready, ensure theme is still correct
				handleThemeChange();
			}
		});
	</script>

<style>
	.giscus-container {
		margin-top: 3rem;
		padding-top: 2rem;
		border-top: 1px solid rgba(var(--gray), 0.2);
	}

	/* Dark mode support for Giscus */
	[data-theme='dark'] .giscus-container {
		border-top-color: rgba(var(--gray), 0.3);
	}

	/* Ensure proper spacing */
	.giscus-container :global(.giscus) {
		margin: 0;
	}

	/* Custom styling to match your site's theme */
	.giscus-container :global(.giscus-frame) {
		border-radius: 0.75rem;
		overflow: hidden;
	}

	/* Setup notice styling */
	.giscus-setup-notice {
		margin-top: 3rem;
		padding: 2rem;
		text-align: center;
		background: rgba(var(--gray-light), 0.3);
		border-radius: 0.75rem;
		border: 1px solid rgba(var(--gray), 0.2);
	}

	.giscus-setup-notice h3 {
		margin: 0 0 0.5rem 0;
		color: rgb(var(--accent));
		font-size: 1.25rem;
	}

	.giscus-setup-notice p {
		margin: 0;
		color: rgb(var(--gray));
		font-size: 0.95rem;
	}

	/* Dark mode for setup notice */
	[data-theme='dark'] .giscus-setup-notice {
		background: rgba(var(--gray-light), 0.1);
		border-color: rgba(var(--gray), 0.3);
	}

	/* Responsive adjustments */
	@media (max-width: 768px) {
		.giscus-container {
			margin-top: 2rem;
			padding-top: 1.5rem;
		}
		
		.giscus-setup-notice {
			margin-top: 2rem;
			padding: 1.5rem;
		}
	}
</style>
