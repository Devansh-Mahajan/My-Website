---
import { getGiscusConfig, isGiscusConfigured } from '../config/giscus';

// Get Giscus configuration
const config = getGiscusConfig();
const isConfigured = isGiscusConfigured();
---

{isConfigured && (
	<div id="giscus-comments" class="giscus-container">
		<script 
			src="https://giscus.app/client.js"
			data-repo={config.repo}
			data-repo-id={config.repoId}
			data-category={config.category}
			data-category-id={config.categoryId}
			data-mapping={config.mapping}
			data-strict={config.strict}
			data-reactions-enabled={config.reactionsEnabled}
			data-emit-metadata={config.emitMetadata}
			data-input-position={config.inputPosition}
			data-theme={config.theme}
			data-lang={config.lang}
			data-loading={config.loading}
			crossorigin="anonymous"
			async>
		</script>
	</div>
)}

	{!isConfigured && (
		<div class="giscus-setup-notice">
			<h3>ðŸ’¬ Comments Coming Soon</h3>
			<p>Comments will be available once Giscus is configured. Check the setup instructions in the repository.</p>
		</div>
	)}

	<!-- Theme synchronization script -->
	<script>
		// Function to get current theme
		function getCurrentTheme() {
			const htmlElement = document.documentElement;
			const theme = htmlElement.getAttribute('data-theme');
			return theme === 'dark' ? 'dark' : 'light';
		}

		// Function to update Giscus theme
		function updateGiscusTheme(theme) {
			const giscusFrame = document.querySelector('iframe[src*="giscus.app"]');
			if (giscusFrame) {
				// Send theme change message to Giscus iframe
				giscusFrame.contentWindow.postMessage({
					giscus: {
						setConfig: {
							theme: theme
						}
					}
				}, 'https://giscus.app');
			}
		}

		// Function to handle theme changes
		function handleThemeChange() {
			const currentTheme = getCurrentTheme();
			updateGiscusTheme(currentTheme);
		}

		// Listen for theme changes via data-theme attribute changes
		const observer = new MutationObserver(function(mutations) {
			mutations.forEach(function(mutation) {
				if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
					handleThemeChange();
				}
			});
		});

		// Start observing the document element for theme changes
		observer.observe(document.documentElement, {
			attributes: true,
			attributeFilter: ['data-theme']
		});

		// Also listen for theme toggle clicks as a backup
		document.addEventListener('click', function(event) {
			if (event.target.closest('#theme-toggle')) {
				// Small delay to allow theme change to complete
				setTimeout(handleThemeChange, 100);
			}
		});

		// Initialize theme on page load
		document.addEventListener('DOMContentLoaded', function() {
			// Wait for Giscus to load, then set initial theme
			setTimeout(handleThemeChange, 2000);
		});

		// Listen for Giscus ready event
		window.addEventListener('message', function(event) {
			if (event.origin !== 'https://giscus.app') return;
			
			if (event.data && event.data.type === 'ready') {
				// Giscus is ready, set the initial theme
				handleThemeChange();
			}
		});
	</script>

<style>
	.giscus-container {
		margin-top: 3rem;
		padding-top: 2rem;
		border-top: 1px solid rgba(var(--gray), 0.2);
	}

	/* Dark mode support for Giscus */
	[data-theme='dark'] .giscus-container {
		border-top-color: rgba(var(--gray), 0.3);
	}

	/* Ensure proper spacing */
	.giscus-container :global(.giscus) {
		margin: 0;
	}

	/* Custom styling to match your site's theme */
	.giscus-container :global(.giscus-frame) {
		border-radius: 0.75rem;
		overflow: hidden;
	}

	/* Setup notice styling */
	.giscus-setup-notice {
		margin-top: 3rem;
		padding: 2rem;
		text-align: center;
		background: rgba(var(--gray-light), 0.3);
		border-radius: 0.75rem;
		border: 1px solid rgba(var(--gray), 0.2);
	}

	.giscus-setup-notice h3 {
		margin: 0 0 0.5rem 0;
		color: rgb(var(--accent));
		font-size: 1.25rem;
	}

	.giscus-setup-notice p {
		margin: 0;
		color: rgb(var(--gray));
		font-size: 0.95rem;
	}

	/* Dark mode for setup notice */
	[data-theme='dark'] .giscus-setup-notice {
		background: rgba(var(--gray-light), 0.1);
		border-color: rgba(var(--gray), 0.3);
	}

	/* Responsive adjustments */
	@media (max-width: 768px) {
		.giscus-container {
			margin-top: 2rem;
			padding-top: 1.5rem;
		}
		
		.giscus-setup-notice {
			margin-top: 2rem;
			padding: 1.5rem;
		}
	}
</style>
